---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { glossaryData } from "@/data/glossary.js";
import YrxLogo from "@/components/assets/yrxLogo.astro";
import SubscribeCta from "@/components/blog/SubscribeCta.astro";

export async function getStaticPaths() {
  return glossaryData.map((term) => ({
    params: { slug: term.slug },
    props: { term }
  }));
}

const { term } = Astro.props;

if (!term) {
  return Astro.redirect("/glossary");
}

// Get related terms (previous and next alphabetically for simplicity)
const sortedTerms = glossaryData.sort((a, b) => a.question.localeCompare(b.question));
const currentIndex = sortedTerms.findIndex(t => t.slug === term.slug);
const relatedTerms = [
  sortedTerms[currentIndex - 1],
  sortedTerms[currentIndex + 1],
  sortedTerms[currentIndex + 2]
].filter(Boolean).slice(0, 3);

// Get the first letter for breadcrumbs
const firstLetter = term.term.charAt(0).toUpperCase();

// Ensure we have a proper site URL
const siteUrl = Astro.site?.toString() || 'https://yxr.io/';
const currentUrl = `${siteUrl}glossary/${term.slug}`;

// Structured Data - Fixed and simplified
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "DefinedTerm",
      "@id": `${currentUrl}#term`,
      "name": term.term,
      "alternateName": term.question,
      "description": term.answer,
      "url": currentUrl,
      "inDefinedTermSet": {
        "@type": "DefinedTermSet",
        "@id": `${siteUrl}glossary#termset`,
        "name": "SEO & Marketing Glossary",
        "description": "Comprehensive glossary of SEO and marketing terms",
        "url": `${siteUrl}glossary`
      }
    },
    {
      "@type": "WebPage",
      "@id": currentUrl,
      "url": currentUrl,
      "name": term.question,
      "headline": term.question,
      "description": term.answer,
      "datePublished": term.updated || new Date().toISOString(),
      "dateModified": term.updated || new Date().toISOString(),
      "inLanguage": "en-US",
      "mainEntity": {
        "@id": `${currentUrl}#term`
      },
      "isPartOf": {
        "@type": "WebSite",
        "@id": siteUrl,
        "name": "yxr.io",
        "url": siteUrl
      },
      "author": {
        "@type": "Organization",
        "name": "yxr.io",
        "url": siteUrl
      },
      "publisher": {
        "@type": "Organization",
        "name": "yxr.io",
        "url": siteUrl,
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}logo.png`
        }
      }
    },
    {
      "@type": "BreadcrumbList",
      "@id": `${currentUrl}#breadcrumbs`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Glossary",
          "item": `${siteUrl}glossary`
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": `Letter ${firstLetter}`,
          "item": `${siteUrl}glossary/letters/${firstLetter.toLowerCase()}`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": term.term,
          "item": currentUrl
        }
      ]
    }
  ]
};

// FAQ structured data if the content has FAQ-like structure
const faqStructuredData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": {
    "@type": "Question",
    "name": term.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": term.answer
    }
  }
};

const pageTitle = `${term.question} - SEO Glossary | yxr.io`;
const pageDescription = term.answer;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Fragment slot="head">
    <link rel="canonical" href={currentUrl} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={currentUrl} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    
    <!-- Main structured data -->
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>
    
    <!-- FAQ structured data -->
    <script type="application/ld+json" set:html={JSON.stringify(faqStructuredData)}></script>
  </Fragment>

  <!-- Breadcrumb Navigation -->
  <section class="py-8">
    <div class="mx-auto px-4 lg:px-8 max-w-4xl">
      <nav aria-label="Breadcrumb" class="text-sm">
        <ol class="flex items-center space-x-2 text-gray-500">
          <li>
            <a href="/glossary" class="hover:text-accent-500 transition-colors">
              Glossary
            </a>
          </li>
          <li>
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <a href={`/glossary/letters/${firstLetter.toLowerCase()}`} class="hover:text-accent-500 transition-colors">
              {firstLetter}
            </a>
          </li>
          <li>
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li class="text-gray-700 font-medium">
            {term.term}
          </li>
        </ol>
      </nav>
    </div>
  </section>

  <!-- Main Content -->
  <section class="pt-0 pb-8 lg:pb-16 bg-white">
    <div class="mx-auto px-4 lg:px-8 max-w-4xl">
      
      <!-- H1 - Exact question for featured snippets -->
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-6">
          {term.question}
        </h1>
        
        <!-- Answer paragraph - 40-60 words for featured snippets -->
        <div class="text-lg text-gray-700 leading-relaxed mb-8 p-6 bg-accent-50 rounded-lg border-l-4 border-accent-500">
          <p class="font-medium">{term.answer}</p>
        </div>
      </header>

      <!-- Logo -->
      <div class="mb-8 w-64">
        <YrxLogo />
      </div>

      <!-- Subscribe CTA -->
      <SubscribeCta />

      <!-- Supporting content from HTML field -->
      <div class="prose prose-lg max-w-none mb-12 text-gray-800">
        <Fragment set:html={term.html} />
      </div>

      <!-- Related Terms -->
      {relatedTerms.length > 0 && (
        <section class="mt-12 pt-8 border-t border-gray-200">
          <h2 class="text-2xl font-semibold text-gray-900 mb-4">
            Related Terms
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {relatedTerms.map((relatedTerm) => relatedTerm && (
              <a 
                href={`/glossary/${relatedTerm.slug}`}
                class="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200 hover:border-accent-300"
              >
                <h3 class="text-lg font-medium text-gray-900 mb-2">
                  {relatedTerm.question}
                </h3>
                <p class="text-sm text-gray-600 line-clamp-2">
                  {relatedTerm.answer.slice(0, 80)}...
                </p>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Back to Glossary -->
      <div class="mt-12 pt-8 border-t border-gray-200">
        <a 
          href="/glossary"
          class="inline-flex items-center gap-2 text-accent-500 hover:text-accent-700 font-medium transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Glossary
        </a>
      </div>
    </div>
  </section>

  <!-- Bottom Subscribe CTA -->
  <SubscribeCta />
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .prose h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #1f2937;
  }
  
  .prose ul {
    list-style-type: disc;
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
    color: #374151;
  }
  
  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }
  
  .prose th,
  .prose td {
    border: 1px solid #d1d5db;
    padding: 0.75rem;
    text-align: left;
  }
  
  .prose th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #1f2937;
  }
  
  .prose td {
    color: #374151;
  }
</style>